name: Continuous Integration ğŸ‘®â€â™‚ï¸ & Deployment ğŸ‘¨â€ğŸ¨

on:
  push:
    branches:
      - master

jobs:
  Integration:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source ğŸ“¡
        uses: actions/checkout@v2
      - name: Cache Stack ğŸ“¦
        uses: actions/cache@v2
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}-${{ hashFiles('**/package.yaml') }}
          restore-keys: |
            ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}-
            ${{ runner.os }}-stack-
      - name: Upgrade Stack ğŸ“¡
        run: stack upgrade
      - name: Build âš’
        run: stack build --test --no-run-tests
      - name: Test ğŸš§
        run: stack test
  Deployment:
    runs-on: ubuntu-latest
    needs: Integration
    strategy:
      matrix:
        exec:
          - 1
          - 2
          - 3
          - 4
          - 5
          - 6
          - 7
          - 8
          - 9
    steps:
      - name: Checkout source ğŸ“¡
        uses: actions/checkout@v2
      - name: Cache Stack ğŸ“¦
        uses: actions/cache@v2
        with:
          path: ~/.stack
          key: ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}-${{ hashFiles('**/package.yaml') }}
          restore-keys: |
            ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}-
            ${{ runner.os }}-stack-
      - name: Upgrade Stack ğŸ“¡
        run: stack upgrade
      - name: Build âš’
        run: stack build
      - name: Create .output directory ğŸ§¹
        run: mkdir .output
      - name: Run ğŸš€
        run: stack run ${{ matrix.exec }}
      - name: PPM to JPEG ğŸ–¼
        working-directory: ./.output
        run: |
          for i in *.ppm ; do
            [ -f "$i" ] || continue;
            mogrify -format jpg "$i";
          done
      - name: Deploy ğŸ§¾
        uses: JamesIves/github-pages-deploy-action@4.1.1
        with:
          branch: gh-pages
          folder: .output
          clean: false
